<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCloud Album Viewer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.light {
            background-color: #ffffff;
            color: #1d1d1f;
        }

        body.dark {
            background-color: #000000;
            color: #f5f5f7;
        }

        #root {
            width: 100%;
            min-height: 100vh;
        }

        .fade-out {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #e8e8e8 25%, #f5f5f5 50%, #e8e8e8 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #1c1c1e 25%, #2c2c2e 50%, #1c1c1e 75%);
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        .photo-card:hover .thumbnail-download {
            opacity: 1 !important;
        }

        .loading-dots {
            display: inline-flex;
            gap: 2px;
        }

        .loading-dots span {
            animation: dotFade 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dotFade {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="light">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const Sun = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="4"/>
                <path d="M12 2v2"/>
                <path d="M12 20v2"/>
                <path d="m4.93 4.93 1.41 1.41"/>
                <path d="m17.66 17.66 1.41 1.41"/>
                <path d="M2 12h2"/>
                <path d="M20 12h2"/>
                <path d="m6.34 17.66-1.41 1.41"/>
                <path d="m19.07 4.93-1.41 1.41"/>
            </svg>
        );

        const Moon = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const Minus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const ArrowLeft = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 19-7-7 7-7"/>
                <path d="M19 12H5"/>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const Play = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
        );

        const CalendarArrowDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m14 18 4 4 4-4"/>
                <path d="M16 2v4"/>
                <path d="M18 14v8"/>
                <path d="M21 11.354V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7.343"/>
                <path d="M3 10h18"/>
                <path d="M8 2v4"/>
            </svg>
        );

        const CalendarArrowUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m14 18 4-4 4 4"/>
                <path d="M16 2v4"/>
                <path d="M18 22v-8"/>
                <path d="M21 11.343V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7.343"/>
                <path d="M3 10h18"/>
                <path d="M8 2v4"/>
            </svg>
        );

        const ICloudAlbumViewer = () => {
            const [albumUrl, setAlbumUrl] = useState('');
            const [loading, setLoading] = useState(false);
            const [photos, setPhotos] = useState([]);
            const [loadedPhotos, setLoadedPhotos] = useState({});
            const [error, setError] = useState('');
            const [albumInfo, setAlbumInfo] = useState(null);
            const [showLanding, setShowLanding] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [columns, setColumns] = useState(6);
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [sortOrder, setSortOrder] = useState('newest');
            const [videoDurations, setVideoDurations] = useState({});

            // Calculate grid padding based on approximate square size
            const getGridPadding = () => {
                // Estimate square size: viewport width / columns
                const approxSquareSize = (typeof window !== 'undefined' ? window.innerWidth : 1200) / columns;
                
                if (approxSquareSize < 32) return '1px';
                if (approxSquareSize < 72) return '2px';
                return '4px';
            };

            // Calculate approximate square size for conditional rendering
            const getSquareSize = () => {
                return (typeof window !== 'undefined' ? window.innerWidth : 1200) / columns;
            };

            const [gridPadding, setGridPadding] = useState(getGridPadding());
            const [squareSize, setSquareSize] = useState(getSquareSize());

            // Update grid padding and square size when columns change
            useEffect(() => {
                setGridPadding(getGridPadding());
                setSquareSize(getSquareSize());
            }, [columns]);

            // Update grid padding and square size on window resize
            useEffect(() => {
                const handleResize = () => {
                    setGridPadding(getGridPadding());
                    setSquareSize(getSquareSize());
                };
                
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [columns]);

            // Format duration in mm:ss
            const formatDuration = (seconds) => {
                if (!seconds) return null;
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // Sort photos based on current sort order
            const sortedPhotos = React.useMemo(() => {
                if (!photos.length) return photos;
                return [...photos].sort((a, b) => {
                    const dateA = a.dateCreated || a.batchDateCreated || '0';
                    const dateB = b.dateCreated || b.batchDateCreated || '0';
                    return sortOrder === 'newest' 
                        ? dateB.localeCompare(dateA)
                        : dateA.localeCompare(dateB);
                });
            }, [photos, sortOrder]);

            useEffect(() => {
                document.body.className = darkMode ? 'dark' : 'light';
            }, [darkMode]);


            useEffect(() => {
                const token = getTokenFromHash();
                if (token) {
                    const albumLink = `https://www.icloud.com/sharedalbum/#${token}`;
                    setAlbumUrl(albumLink);
                    fetchAlbumData(albumLink);
                }
            }, []);


            // Load video durations by creating hidden video elements
            useEffect(() => {
                if (photos.length === 0) return;
                
                const videos = photos.filter(p => p.isVideo && p.videoUrl);
                videos.forEach(video => {
                    if (videoDurations[video.id]) return;
                    
                    const videoEl = document.createElement('video');
                    videoEl.preload = 'metadata';
                    videoEl.src = video.videoUrl;
                    videoEl.onloadedmetadata = () => {
                        setVideoDurations(prev => ({
                            ...prev,
                            [video.id]: videoEl.duration
                        }));
                    };
                });
            }, [photos]);

            // Keyboard navigation for overlay
            useEffect(() => {
                if (!selectedPhoto) return;

                const handleKeyDown = (e) => {
                    const currentIndex = sortedPhotos.findIndex(p => p.id === selectedPhoto.id);
                    
                    if (e.key === 'ArrowLeft' && currentIndex > 0) {
                        setSelectedPhoto(sortedPhotos[currentIndex - 1]);
                    } else if (e.key === 'ArrowRight' && currentIndex < sortedPhotos.length - 1) {
                        setSelectedPhoto(sortedPhotos[currentIndex + 1]);
                    } else if (e.key === 'Escape') {
                        setSelectedPhoto(null);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedPhoto, sortedPhotos]);

            // Touch swipe navigation for overlay
            useEffect(() => {
                if (!selectedPhoto) return;

                let touchStartX = 0;
                let touchEndX = 0;
                const minSwipeDistance = 50; // minimum distance for a swipe

                const handleTouchStart = (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                };

                const handleTouchEnd = (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                };

                const handleSwipe = () => {
                    const swipeDistance = touchStartX - touchEndX;
                    const currentIndex = sortedPhotos.findIndex(p => p.id === selectedPhoto.id);

                    // Swipe left (next photo)
                    if (swipeDistance > minSwipeDistance && currentIndex < sortedPhotos.length - 1) {
                        setSelectedPhoto(sortedPhotos[currentIndex + 1]);
                    }
                    // Swipe right (previous photo)
                    else if (swipeDistance < -minSwipeDistance && currentIndex > 0) {
                        setSelectedPhoto(sortedPhotos[currentIndex - 1]);
                    }
                };

                window.addEventListener('touchstart', handleTouchStart);
                window.addEventListener('touchend', handleTouchEnd);

                return () => {
                    window.removeEventListener('touchstart', handleTouchStart);
                    window.removeEventListener('touchend', handleTouchEnd);
                };
            }, [selectedPhoto, sortedPhotos]);

            const getApiUrl = () => {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return 'http://localhost:3001';
                }
                return '';
            };

            const extractAlbumToken = (url) => {
                const match = url.match(/#([A-Za-z0-9]+)/);
                return match ? match[1] : null;
            };


            const getTokenFromHash = () => {
                const hash = window.location.hash;
                return hash && hash.length > 1 ? hash.substring(1) : null;
            };

            const updateHashFromUrl = (url) => {
                const token = extractAlbumToken(url);
                if (token) {
                    window.location.hash = token;
                }
            };


            const fetchAlbumData = async (url) => {
                setShowLanding(false);
                setLoading(true);
                setError('');
                setPhotos([]);
                setLoadedPhotos({});
                setAlbumInfo(null);

                try {
                    const token = extractAlbumToken(url);
                    if (!token) {
                        throw new Error('Invalid iCloud album URL format');
                    }

                    const apiUrl = getApiUrl();
                    const response = await fetch(`${apiUrl}/api/album/${token}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch album data');
                    }

                    const data = await response.json();
                    
                    if (data.photos && data.photos.length > 0) {
                        setAlbumInfo({
                            name: data.streamName || 'Shared Album',
                            photoCount: data.photos.length
                        });

                        const photoList = data.photos.map(photo => {
                            const derivatives = photo.derivatives || {};
                            const sortedKeys = Object.keys(derivatives).sort((a, b) => {
                                const aWidth = parseInt(derivatives[a].width) || 0;
                                const bWidth = parseInt(derivatives[b].width) || 0;
                                return aWidth - bWidth;
                            });
                            
                            let thumbnailUrl = null;
                            let fullUrl = null;
                            let videoUrl = null;
                            
                            if (photo.mediaAssetType === 'video' && derivatives['PosterFrame']?.url) {
                                thumbnailUrl = derivatives['PosterFrame'].url;
                            }
                            
                            for (const key of sortedKeys) {
                                const d = derivatives[key];
                                if (d.url) {
                                    if (!thumbnailUrl) thumbnailUrl = d.url;
                                    fullUrl = d.url;
                                }
                            }
                            
                            // For videos, get the actual video URL (not poster frame)
                            if (photo.mediaAssetType === 'video') {
                                // Look for video derivatives (usually 720p, 360p, etc.)
                                for (const key of sortedKeys) {
                                    const d = derivatives[key];
                                    if (d.url && key !== 'PosterFrame') {
                                        videoUrl = d.url;
                                    }
                                }
                            }

                            return {
                                id: photo.photoGuid,
                                thumbnail: thumbnailUrl,
                                fullUrl: fullUrl,
                                videoUrl: videoUrl,
                                caption: photo.caption || '',
                                dateCreated: photo.dateCreated,
                                batchDateCreated: photo.batchDateCreated,
                                isVideo: photo.mediaAssetType === 'video',
                                duration: photo.duration ? parseFloat(photo.duration) : null,
                                width: parseInt(photo.width) || 1,
                                height: parseInt(photo.height) || 1
                            };
                        }).filter(p => p.thumbnail);

                        // Sort by date (newest first by default)
                        photoList.sort((a, b) => {
                            const dateA = a.dateCreated || a.batchDateCreated || '0';
                            const dateB = b.dateCreated || b.batchDateCreated || '0';
                            return dateB.localeCompare(dateA);
                        });

                        setPhotos(photoList);
                    } else {
                        throw new Error('No photos found in this album');
                    }
                } catch (err) {
                    setError(err.message || 'Failed to load album');
                    setShowLanding(true);
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!albumUrl.trim()) return;
                updateHashFromUrl(albumUrl);
                fetchAlbumData(albumUrl);
            };

            const handleImageLoad = (photoId) => {
                setLoadedPhotos(prev => ({ ...prev, [photoId]: true }));
            };

            const downloadImage = async (photo, e) => {
                e?.stopPropagation();
                try {
                    // Use videoUrl for videos, fullUrl for images
                    const mediaUrl = photo.isVideo 
                        ? (photo.videoUrl || photo.fullUrl) 
                        : (photo.fullUrl || photo.thumbnail);
                    
                    const filename = `${photo.isVideo ? 'video' : 'photo'}-${photo.id}.${photo.isVideo ? 'mp4' : 'jpg'}`;
                    
                    // Use server proxy to bypass CORS
                    const apiUrl = getApiUrl();
                    const proxyUrl = `${apiUrl}/api/download?url=${encodeURIComponent(mediaUrl)}&filename=${encodeURIComponent(filename)}`;
                    
                    // Create a link and trigger download
                    const a = document.createElement('a');
                    a.href = proxyUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } catch (err) {
                    console.error('Download failed:', err);
                }
            };

            const styles = {
                container: {
                    minHeight: '100vh',
                    display: 'flex',
                    flexDirection: 'column'
                },
                landing: {
                    flex: 1,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '2rem',
                    transition: 'opacity 0.4s ease, transform 0.4s ease'
                },
                title: {
                    fontSize: '2rem',
                    fontWeight: 600,
                    marginBottom: '0.5rem',
                    letterSpacing: '-0.02em'
                },
                subtitle: {
                    fontSize: '1rem',
                    opacity: 0.6,
                    marginBottom: '2.5rem',
                    textAlign: 'center'
                },
                form: {
                    width: '100%',
                    maxWidth: '480px',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                },
                input: {
                    padding: '14px 18px',
                    fontSize: '16px',
                    border: `1px solid ${darkMode ? '#333' : '#d2d2d7'}`,
                    borderRadius: '12px',
                    background: darkMode ? '#1c1c1e' : '#fff',
                    color: darkMode ? '#f5f5f7' : '#1d1d1f',
                    outline: 'none',
                    transition: 'border-color 0.2s, box-shadow 0.2s'
                },
                button: {
                    padding: '14px 24px',
                    fontSize: '16px',
                    fontWeight: 500,
                    border: 'none',
                    borderRadius: '12px',
                    background: '#007aff',
                    color: '#fff',
                    cursor: 'pointer',
                    transition: 'opacity 0.2s, transform 0.1s'
                },
                header: {
                    position: 'sticky',
                    top: 0,
                    zIndex: 100,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '8px 20px',
                    background: darkMode ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderBottom: `1px solid ${darkMode ? '#333' : '#e5e5e5'}`
                },
                headerLeft: {
                    display: 'flex',
                    flexDirection: 'column'
                },
                albumTitle: {
                    fontSize: '24px',
                    fontWeight: 600,
                    letterSpacing: '-0.01em'
                },
                photoCount: {
                    fontSize: '13px',
                    opacity: 0.6
                },
                themeToggle: {
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: '8px',
                    borderRadius: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: darkMode ? '#f5f5f7' : '#1d1d1f',
                    transition: 'background 0.2s'
                },
                grid: {
                    display: 'grid',
                    gridTemplateColumns: `repeat(${columns}, 1fr)`,
                    gap: gridPadding,
                    padding: gridPadding
                },
                photoCard: {
                    position: 'relative',
                    aspectRatio: '1',
                    overflow: 'hidden',
                    cursor: 'pointer',
                    background: darkMode ? '#1c1c1e' : '#f5f5f7'
                },
                photoImage: {
                    width: '100%',
                    height: '100%',
                    objectFit: 'cover',
                    transition: 'transform 0.3s ease'
                },
                videoIndicator: {
                    position: 'absolute',
                    top: '50%',
                    left: '50%',
                    transform: 'translate(-50%, -50%)',
                    background: 'rgba(0,0,0,0.5)',
                    borderRadius: '50%',
                    width: '40px',
                    height: '40px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#fff'
                },
                videoDuration: {
                    position: 'absolute',
                    bottom: '6px',
                    right: '6px',
                    background: 'rgba(0,0,0,0.6)',
                    borderRadius: '4px',
                    padding: '2px 6px',
                    fontSize: '11px',
                    fontWeight: 500,
                    color: '#fff',
                    fontVariantNumeric: 'tabular-nums'
                },
                thumbnailDownload: {
                    position: 'absolute',
                    top: '6px',
                    right: '6px',
                    background: 'rgba(0,0,0,0.6)',
                    borderRadius: '6px',
                    padding: '6px',
                    border: 'none',
                    cursor: 'pointer',
                    color: '#fff',
                    opacity: 0,
                    transition: 'opacity 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                },
                zoomControls: {
                    position: 'fixed',
                    bottom: '20px',
                    right: '20px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    background: darkMode ? 'rgba(28,28,30,0.9)' : 'rgba(255,255,255,0.9)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    padding: '8px 12px',
                    borderRadius: '12px',
                    boxShadow: '0 2px 20px rgba(0,0,0,0.15)',
                    border: `1px solid ${darkMode ? '#333' : '#e5e5e5'}`
                },
                zoomButton: {
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: '4px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: darkMode ? '#f5f5f7' : '#1d1d1f',
                    opacity: 0.8
                },
                slider: {
                    width: '80px',
                    background: darkMode ? '#444' : '#d2d2d7'
                },
                overlay: {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: darkMode ? 'rgba(0,0,0,0.95)' : 'rgba(255,255,255,0.95)',
                    zIndex: 1000,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center'
                },
                overlayHeader: {
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '16px 20px',
                    background: 'transparent'
                },
                backButton: {
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    color: '#007aff',
                    fontSize: '17px'
                },
                downloadButton: {
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: '8px',
                    color: '#007aff'
                },
                overlayImage: {
                    maxWidth: '90vw',
                    maxHeight: '85vh',
                    objectFit: 'contain'
                },
                error: {
                    color: '#ff3b30',
                    marginTop: '1rem',
                    fontSize: '14px'
                }
            };

            // Skeleton grid for loading
            const SkeletonGrid = () => (
                <div style={styles.grid}>
                    {Array.from({ length: columns * 4 }).map((_, i) => (
                        <div key={i} style={styles.photoCard} className="skeleton" />
                    ))}
                </div>
            );

            return (
                <div style={styles.container}>
                    {/* Landing Page */}
                    {showLanding && (
                        <div style={styles.landing} className={showLanding ? '' : 'fade-out'}>
                            <h1 style={styles.title}>iCloud Album Viewer</h1>
                            <p style={styles.subtitle}>
                                Paste a shared iCloud album link to view photos
                            </p>
                            <form onSubmit={handleSubmit} style={styles.form}>
                                <input
                                    type="text"
                                    value={albumUrl}
                                    onChange={(e) => setAlbumUrl(e.target.value)}
                                    placeholder="https://www.icloud.com/sharedalbum/#..."
                                    style={styles.input}
                                />
                                <button 
                                    type="submit" 
                                    style={{
                                        ...styles.button,
                                        opacity: albumUrl.trim() ? 1 : 0.5,
                                        cursor: albumUrl.trim() ? 'pointer' : 'not-allowed'
                                    }}
                                    disabled={!albumUrl.trim()}
                                >
                                    View Album
                                </button>
                            </form>
                            {error && <p style={styles.error}>{error}</p>}
                        </div>
                    )}

                    {/* Album View */}
                    {!showLanding && (
                        <>
                            {/* Sticky Header */}
                            <header style={styles.header}>
                                <div style={styles.headerLeft}>
                                    <span style={styles.albumTitle}>
                                        {loading ? (
                                            <span>iCloud Album Loading<span className="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                                        ) : (
                                            albumInfo?.name || 'Shared Album'
                                        )}
                                    </span>
                                    <span style={styles.photoCount}>
                                        {!loading && albumInfo ? `${albumInfo.photoCount} photos` : ''}
                                    </span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <button 
                                        style={styles.themeToggle}
                                        onClick={() => setSortOrder(s => s === 'newest' ? 'oldest' : 'newest')}
                                        title={sortOrder === 'newest' ? 'Showing newest first' : 'Showing oldest first'}
                                    >
                                        {sortOrder === 'newest' ? <CalendarArrowDown size={20} /> : <CalendarArrowUp size={20} />}
                                    </button>
                                    <button 
                                        style={styles.themeToggle}
                                        onClick={() => setDarkMode(!darkMode)}
                                        title={darkMode ? 'Light mode' : 'Dark mode'}
                                    >
                                        {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                                    </button>
                                </div>
                            </header>

                            {/* Photo Grid or Skeleton */}
                            {loading ? (
                                <SkeletonGrid />
                            ) : (
                                <div style={styles.grid}>
                                    {sortedPhotos.map((photo) => (
                                        <div 
                                            key={photo.id}
                                            className="photo-card"
                                            style={styles.photoCard}
                                            onClick={() => setSelectedPhoto(photo)}
                                        >
                                            {!loadedPhotos[photo.id] && (
                                                <div 
                                                    className="skeleton" 
                                                    style={{ 
                                                        position: 'absolute', 
                                                        inset: 0 
                                                    }} 
                                                />
                                            )}
                                            <img
                                                src={photo.thumbnail}
                                                alt={photo.caption || ''}
                                                style={{
                                                    ...styles.photoImage,
                                                    opacity: loadedPhotos[photo.id] ? 1 : 0
                                                }}
                                                onLoad={() => handleImageLoad(photo.id)}
                                            />
                                            {loadedPhotos[photo.id] && (
                                                <button
                                                    className="thumbnail-download"
                                                    style={styles.thumbnailDownload}
                                                    onClick={(e) => downloadImage(photo, e)}
                                                    title="Download"
                                                >
                                                    <Download size={14} />
                                                </button>
                                            )}
                                            {photo.isVideo && loadedPhotos[photo.id] && (
                                                <div style={styles.videoIndicator}>
                                                    <Play size={16} />
                                                </div>
                                            )}
                                            {photo.isVideo && videoDurations[photo.id] && loadedPhotos[photo.id] && squareSize >= 48 && (
                                                <div style={styles.videoDuration}>
                                                    {formatDuration(videoDurations[photo.id])}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Zoom Controls */}
                            {!loading && sortedPhotos.length > 0 && (
                                <div style={styles.zoomControls}>
                                    <button 
                                        style={styles.zoomButton}
                                        onClick={() => setColumns(c => Math.min(c + 1, 20))}
                                        title="Smaller"
                                    >
                                        <Minus size={18} />
                                    </button>
                                    <input
                                        type="range"
                                        min="2"
                                        max="20"
                                        value={22 - columns}
                                        onChange={(e) => setColumns(22 - parseInt(e.target.value))}
                                        style={styles.slider}
                                    />
                                    <button 
                                        style={styles.zoomButton}
                                        onClick={() => setColumns(c => Math.max(c - 1, 2))}
                                        title="Larger"
                                    >
                                        <Plus size={18} />
                                    </button>
                                </div>
                            )}
                        </>
                    )}

                    {/* Full Image/Video Overlay */}
                    {selectedPhoto && (
                        <div style={styles.overlay} className="fade-in">
                            <div style={styles.overlayHeader}>
                                <button 
                                    style={styles.backButton}
                                    onClick={() => setSelectedPhoto(null)}
                                >
                                    <ArrowLeft size={20} />
                                    <span>Back</span>
                                </button>
                                <button
                                    style={styles.downloadButton}
                                    onClick={(e) => downloadImage(selectedPhoto, e)}
                                    title="Download"
                                >
                                    <Download size={22} />
                                </button>
                            </div>
                            {selectedPhoto.isVideo ? (
                                <video
                                    src={selectedPhoto.videoUrl || selectedPhoto.fullUrl}
                                    style={styles.overlayImage}
                                    controls
                                    autoPlay
                                    playsInline
                                />
                            ) : (
                                <img
                                    src={selectedPhoto.fullUrl || selectedPhoto.thumbnail}
                                    alt={selectedPhoto.caption || ''}
                                    style={styles.overlayImage}
                                />
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ICloudAlbumViewer />);
    </script>
</body>
</html>